# Код для платы Wemos d1 mini из проекта "Система мониторинга электроэнергии"
## Автор - Искрин Артём
## Остальной код, ссылки для тестирования и видео работы:
  • Swagger UI: [https://energy-monitor-fastapi-production.up.railway.app/docs](https://energy-monitor-fastapi-production.up.railway.app/docs)  
  • Пользовательский сайт: [https://green-energy-reporter.netlify.app/](https://green-energy-reporter.netlify.app/)  
  • GitHub Бэкэнда(API): [https://github.com/deprotate/energy-monitor-fastapi](https://github.com/deprotate/energy-monitor-fastapi)  
  • GitHub фронтенда: [https://github.com/deprotate/energy-monitor-frontend](https://github.com/deprotate/energy-monitor-frontend)  
• Видео работы: [https://disk.yandex.ru/d/vQEiWjrruTO2ig](https://disk.yandex.ru/d/vQEiWjrruTO2ig)

### Немного о роли Wemos d1 mini



**Назначение устройства:**  
Wemos d1 mini служит для непосредственного считывания данных с подключённой солнечной панели и датчиков тока, а также для передачи полученных значений на бэкэнд через HTTPS POST-запросы. Таким образом, устройство выполняет роль моста между источником энергии (и нагрузкой) и серверной частью системы.

#### Алгоритм работы

1. **Инициализация и подключение к WiFi:**  
   При старте устройства происходит подключение к сети WiFi с заданными параметрами (SSID и пароль). В случае успешного подключения выводится сообщение в монитор порта.

2. **Считывание значений с пинов:**  
   - **Аналоговый пин (A0):**  
     Считывается напряжение от солнечной панели. Значение используется для расчёта выработанной энергии:
     - Если значение больше 500 – к переменной `value_2` прибавляется 10.
     - Если значение находится в диапазоне от 100 до 500 – прибавляется 5.
     - Если значение меньше 100 – прибавление отсутствует.
   - **Цифровые пины (D1 и D2):**  
     Считывается состояние подключения дополнительных устройств (нагрузок):
     - Если на обоих пинах присутствует ток (HIGH) – к переменной `value_1` прибавляется 3.
     - Если ток есть только на одном из пинов – прибавляется 2.
     - Если тока нет ни на одном – прибавляется 1.

3. **Циклический сбор данных:**  
   Каждую секунду (интервал цикла – 1000 мс) происходит обновление показаний и вывод их в монитор порта. После 5 последовательных срабатываний (5-секундный интервал) устройство отправляет два запроса:
   - **Первый запрос:**  
     Тип (`"type"`) равен `1`, а значение (`"value"`) – накопленное значение `value_1` (отражает выработанную энергию).
   - **Второй запрос:**  
     Тип (`"type"`) равен `2`, а значение (`"value"`) – накопленное значение `value_2` (отражает потреблённую энергию).

   После отправки запросов счетчики `cycleCounter`, `value_1` и `value_2` сбрасываются, и цикл начинается заново.

4. **Отправка данных на сервер:**  
   Функция `sendPostRequest` выполняет следующие шаги:
   - Создаётся объект `WiFiClientSecure` для безопасного соединения с сервером.  
   - Формируется HTTPS-запрос к адресу `https://energy-monitor-fastapi-production.up.railway.app/create_energy/` с заголовком `Content-Type: application/json`.
   - Формируется JSON-тело запроса в виде:
     ```json
     {
       "type": "1", 
       "value": "5"
     }
     ```
     где значения `type` и `value` задаются программно.
   - После отправки запроса выводится в монитор порта информация о JSON-теле запроса и полученном ответе от сервера.

#### Схематичная таблица пинов и их назначение

| **Пин**  | **Тип сигнала** | **Назначение**                                                                                                                                                   |
|----------|-----------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **A0**   | Аналоговый      | Считывание напряжения от солнечной панели. Чем выше значение, тем больше выработка энергии, что влияет на увеличение `value_1`.                                    |
| **D1**   | Цифровый        | Контакт для определения наличия тока у дополнительных нагрузок. В совокупности с пином D2 влияет на увеличение `value_2`.                                            |
| **D2**   | Цифровый        | Аналогично пину D1, используется для определения уровня нагрузки. Совместно с D1 позволяет оценить, сколько дополнительных устройств потребляют энергию.        |

#### Пример работы (вывод в монитор порта)

При каждом цикле (1 секунда) в монитор порта выводятся текущие значения:
```
A0: 550 | D1: HIGH | D2: LOW | Value_1: 10 | Value_2: 2
```
После 5 циклов (примерно через 5 секунд) устройство отправляет два POST-запроса:
- **Запрос 1 (type = 1):**  
  Отправляет накопленное значение `value_1` (например, 47).
- **Запрос 2 (type = 2):**  
  Отправляет накопленное значение `value_2` (например, 35).

При отправке запроса выводится сообщение с JSON-телом запроса, а затем – ответ сервера:
```
Отправка POST запроса: {"type":"1","value":"47"}
Ответ сервера: {"id":102, "type":1, "value":47, "created_at": "14.02.2025 in 12.35.10"}
```

---

**Заключение:**  
Код для Wemos d1 mini демонстрирует простой, но эффективный пример взаимодействия устройства с серверной частью системы через HTTPS-запросы. Он позволяет собирать данные с различных датчиков, производить первичную обработку (агрегацию значений) и отправлять результаты в формате JSON на сервер для дальнейшей обработки и визуализации.

